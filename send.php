<?php
//------------------------------------------------------------
// send.php（Lupin 最適化版）
// ・管理者宛てメール送信
// ・送信者へ自動返信メール
// ・入力値チェック
// ・メールヘッダインジェクション対策
// ・UTF-8 マルチバイト対応
//------------------------------------------------------------

// 文字コード設定
mb_language("Japanese");
mb_internal_encoding("UTF-8");

// -----------------------------------------------------------
// 1. 管理者の受信メールアドレス（←ここを書き替えてください）
// -----------------------------------------------------------
$admin_email = "yourmail@example.com";  // ★あなたの受信メール

// -----------------------------------------------------------
// 2. 入力データの受け取り
// -----------------------------------------------------------
$name   = isset($_POST["item1"]) ? trim($_POST["item1"]) : '';
$email  = isset($_POST["item2"]) ? trim($_POST["item2"]) : '';
$detail = isset($_POST["item3"]) ? trim($_POST["item3"]) : '';

// -----------------------------------------------------------
// 3. バリデーション（未入力チェック）
// -----------------------------------------------------------
if ($name === '' || $email === '' || $detail === '') {
    exit("必須項目が未入力です。前のページに戻って入力してください。");
}

// -----------------------------------------------------------
// 4. メールヘッダインジェクション対策
// -----------------------------------------------------------
function h($str){ return htmlspecialchars($str, ENT_QUOTES, 'UTF-8'); }
function safe($str){
    return preg_replace('/[\r\n]+/', '', $str); // 改行除去
}

$name_safe  = safe($name);
$email_safe = safe($email);

// -----------------------------------------------------------
// 5. 管理者宛メール内容
// -----------------------------------------------------------
$admin_subject = "【Lupin】お問い合わせが届きました";
$admin_body =
"以下の内容でお問い合わせを受け付けました。\n\n"
. "■お名前\n" . $name . "\n\n"
. "■メールアドレス\n" . $email . "\n\n"
. "■お問い合わせ内容\n" . $detail . "\n\n"
. "------------------------------\n"
. "合同会社 Lupin\n";

// From ヘッダ（送信者メール）
$admin_headers = "From: " . $email_safe;

// -----------------------------------------------------------
// 6. 管理者へメール送信
// -----------------------------------------------------------
mb_send_mail($admin_email, $admin_subject, $admin_body, $admin_headers);

// -----------------------------------------------------------
// 7. 送信者への自動返信メール
// -----------------------------------------------------------
$user_subject = "【Lupin】お問い合わせありがとうございました";
$user_body =
$name . " 様\n\n"
. "お問い合わせいただきありがとうございます。\n"
. "以下の内容で受け付けました。\n\n"
. "■お名前\n" . $name . "\n\n"
. "■メールアドレス\n" . $email . "\n\n"
. "■お問い合わせ内容\n" . $detail . "\n\n"
. "担当者より改めてご連絡させていただきます。\n\n"
. "------------------------------\n"
. "合同会社 Lupin\n";

// From ヘッダ（管理者のメール）
$user_headers = "From: " . $admin_email;

// 自動返信メール送信
mb_send_mail($email_safe, $user_subject, $user_body, $user_headers);

// -----------------------------------------------------------
// 8. 完了画面へリダイレクト
// -----------------------------------------------------------
header("Location: finish.html");
exit();

?>

